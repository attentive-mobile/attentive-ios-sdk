version: 2.1

# ========================
# Executors
# ========================
executors:
  macos-xcode:
    macos:
      xcode: "26.1.1"
    resource_class: m4pro.medium
    environment:
      HOMEBREW_NO_AUTO_UPDATE: "1"
      FASTLANE_SKIP_UPDATE_CHECK: "YES"
      LC_ALL: "en_US.UTF-8"
      LANG: "en_US.UTF-8"

# ========================
# Orbs
# ========================
orbs:
  macos: circleci/macos@2
  aws-cli: circleci/aws-cli@4.0.0

# ========================
# Constants
# ========================
fastlane_reports_dir: &fastlane_reports_dir "fastlane/reports"
fastlane_test_output_dir: &fastlane_test_output_dir "fastlane/test_output"

# ========================
# Commands (Reusable)
# ========================
commands:
  setup-fastlane:
    description: "Install Fastlane via Bundler"
    steps:
      - restore_cache:
          keys:
            - v1-gems-{{ checksum "Gemfile.lock" }}
            - v1-gems-
      - macos/switch-ruby:
          version: "3.3"
      - run:
          name: Install Bundler Dependencies
          command: |
            bundle config set --local path 'vendor/bundle'
            bundle install
      - save_cache:
          key: v1-gems-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle

# ========================
# Jobs
# ========================
jobs:
  # -----------------------
  # Checkout and Setup
  # -----------------------
  checkout-and-setup:
    executor: macos-xcode
    steps:
      - checkout

      # Setup Fastlane
      - setup-fastlane

      # Cache Swift Package Manager dependencies
      - restore_cache:
          keys:
            - v1-spm-{{ checksum "Package.resolved" }}
            - v1-spm-

      # Resolve dependencies via Fastlane
      - run:
          name: Setup Dependencies via Fastlane
          command: bundle exec fastlane setup

      - save_cache:
          key: v1-spm-{{ checksum "Package.resolved" }}
          paths:
            - ~/.swiftpm
            - ~/Library/Developer/Xcode/DerivedData

      - persist_to_workspace:
          root: .
          paths:
            - .

  # -----------------------
  # Lint
  # -----------------------
  lint:
    executor: macos-xcode
    steps:
      - attach_workspace:
          at: .

      - setup-fastlane

      - run:
          name: Run SwiftLint via Fastlane
          command: bundle exec fastlane lint

      - store_test_results:
          path: *fastlane_reports_dir

      - store_artifacts:
          path: *fastlane_reports_dir
          destination: lint-results

  # -----------------------
  # Build Framework
  # -----------------------
  build-framework:
    executor: macos-xcode
    steps:
      - attach_workspace:
          at: .

      - setup-fastlane

      - run:
          name: Build Framework via Fastlane
          command: bundle exec fastlane build_framework

  # -----------------------
  # Build Examples
  # -----------------------
  build-examples:
    executor: macos-xcode
    steps:
      - attach_workspace:
          at: .

      - setup-fastlane

      - run:
          name: Build Example Apps via Fastlane
          command: bundle exec fastlane build_examples

  # -----------------------
  # Unit Tests
  # -----------------------
  unit-tests:
    executor: macos-xcode
    steps:
      - attach_workspace:
          at: .

      - setup-fastlane

      - run:
          name: Run Unit Tests via Fastlane
          command: bundle exec fastlane unit_test

      - store_test_results:
          path: *fastlane_test_output_dir

      - store_artifacts:
          path: *fastlane_test_output_dir
          destination: test-results

  # -----------------------
  # Validate CocoaPods Spec
  # -----------------------
  validate-podspec:
    executor: macos-xcode
    steps:
      - attach_workspace:
          at: .

      - setup-fastlane

      - restore_cache:
          keys:
            - v1-cocoapods-{{ checksum "ATTNSDKFramework.podspec" }}
            - v1-cocoapods-

      - run:
          name: Validate Podspec via Fastlane
          command: bundle exec fastlane validate_podspec

      - save_cache:
          key: v1-cocoapods-{{ checksum "ATTNSDKFramework.podspec" }}
          paths:
            - ~/Library/Caches/CocoaPods

  # -----------------------
  # Validate Swift Package Manager
  # -----------------------
  validate-spm:
    executor: macos-xcode
    steps:
      - attach_workspace:
          at: .

      - setup-fastlane

      - run:
          name: Validate Swift Package via Fastlane
          command: bundle exec fastlane validate_spm

  # -----------------------
  # Deploy to TestFlight
  # -----------------------
  deploy-testflight:
    executor: macos-xcode
    steps:
      - attach_workspace:
          at: .

      - aws-cli/setup:
          region: AWS_REGION
          role_arn: 'arn:aws:iam::026393418737:role/circleci'
          role_session_name: $CIRCLE_JOB-<< pipeline.number >>

      - setup-fastlane

      - run:
          name: Deploy to TestFlight via Fastlane
          command: bundle exec fastlane deploy_testflight

# ========================
# Workflows
# ========================
workflows:
  version: 2

  # Main workflow for all branches
  lint-validate-build-test:
    jobs:
      - checkout-and-setup

      # Run these in parallel after setup
      - lint:
          requires:
            - checkout-and-setup

      - unit-tests:
          requires:
            - checkout-and-setup

      - build-framework:
          requires:
            - checkout-and-setup

      - validate-podspec:
          requires:
            - checkout-and-setup

      - validate-spm:
          requires:
            - checkout-and-setup

      - build-examples:
          requires:
            - lint
            - unit-tests
            - build-framework
            - validate-podspec
            - validate-spm

      - hold-testflight:
          type: approval
          requires:
            - build-examples
          filters:
            branches:
              only: umair/MSDK-241-MSDK-242-MSDK-243-testflight

      - deploy-testflight:
          requires:
            - hold-testflight
          filters:
            branches:
              only: umair/MSDK-241-MSDK-242-MSDK-243-testflight