version: 2.1

# ========================
# Executors
# ========================
executors:
  macos-xcode:
    macos:
      xcode: "26.1.1"
    resource_class: m4pro.medium
    environment:
      HOMEBREW_NO_AUTO_UPDATE: "1"
      FASTLANE_SKIP_UPDATE_CHECK: "YES"
      LC_ALL: "en_US.UTF-8"
      LANG: "en_US.UTF-8"

# ========================
# Orbs
# ========================
orbs:
  macos: circleci/macos@2

# ========================
# Constants
# ========================
fastlane_reports_dir: &fastlane_reports_dir "fastlane/reports"
fastlane_test_output_dir: &fastlane_test_output_dir "fastlane/test_output"

# ========================
# Commands (Reusable)
# ========================
commands:
  setup-fastlane:
    description: "Install Fastlane via Bundler"
    steps:
      - restore_cache:
          keys:
            - v1-gems-{{ checksum "Gemfile.lock" }}
            - v1-gems-
      - macos/switch-ruby:
          version: "3.3"
      - run:
          name: Install Bundler Dependencies
          command: |
            bundle config set --local path 'vendor/bundle'
            bundle install
      - save_cache:
          key: v1-gems-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle

# ========================
# Jobs
# ========================
jobs:
  # -----------------------
  # Checkout and Setup
  # -----------------------
  checkout-and-setup:
    executor: macos-xcode
    steps:
      - checkout

      # Setup Fastlane
      - setup-fastlane

      # Cache Swift Package Manager dependencies
      - restore_cache:
          keys:
            - v1-spm-{{ checksum "Package.resolved" }}
            - v1-spm-

      # Resolve dependencies via Fastlane
      - run:
          name: Setup Dependencies via Fastlane
          command: bundle exec fastlane setup

      - save_cache:
          key: v1-spm-{{ checksum "Package.resolved" }}
          paths:
            - ~/.swiftpm
            - ~/Library/Developer/Xcode/DerivedData

      - persist_to_workspace:
          root: .
          paths:
            - .

  # -----------------------
  # Lint
  # -----------------------
  lint:
    executor: macos-xcode
    steps:
      - attach_workspace:
          at: .

      - setup-fastlane

      - run:
          name: Run SwiftLint via Fastlane
          command: bundle exec fastlane lint

      - store_test_results:
          path: *fastlane_reports_dir

      - store_artifacts:
          path: *fastlane_reports_dir
          destination: lint-results

  # -----------------------
  # Unit Tests
  # -----------------------
  unit-tests:
    executor: macos-xcode
    steps:
      - attach_workspace:
          at: .

      - setup-fastlane

      - run:
          name: Run Unit Tests via Fastlane
          command: bundle exec fastlane unit_test

      - store_test_results:
          path: *fastlane_test_output_dir

      - store_artifacts:
          path: *fastlane_test_output_dir
          destination: test-results

# ========================
# Workflows
# ========================
workflows:
  version: 2

  # Main workflow for all branches
  build-test:
    jobs:
      - checkout-and-setup

  # Run these in parallel after setup
      - lint:
          requires:
            - checkout-and-setup

      - unit-tests:
          requires:
            - checkout-and-setup
