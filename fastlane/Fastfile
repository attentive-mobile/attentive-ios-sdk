# Fastfile for Attentive iOS SDK
# This file contains the fastlane lanes for building, testing, and deploying the iOS SDK

FASTLANE_REPORTS_DIR=ENV['FASTLANE_REPORTS_DIR'] || "fastlane/reports"
FASTLANE_TEST_OUTPUT_DIR=ENV['FASTLANE_TEST_OUTPUT_DIR'] || "fastlane/test_output"
FASTLANE_TEST_DEVICE=ENV['FASTLANE_TEST_DEVICE'] || "iPhone 17 Pro"

default_platform(:ios)

platform :ios do
  # ========================
  # Setup and Dependencies
  # ========================
  before_all do
    setup_circle_ci
  end

  desc "Setup dependencies and environment"
  lane :setup do
    UI.message("üîß Setting up dependencies...")

    # Resolve Swift Package Manager dependencies
    xcodebuild(
      workspace: "attentive-ios-sdk.xcworkspace",
      scheme: "attentive-ios-sdk-framework",
      xcargs: "-resolvePackageDependencies"
    )

    UI.success("‚úÖ Dependencies resolved successfully")
  end

  # ========================
  # Code Quality
  # ========================

  desc "Run SwiftLint"
  lane :lint do
    UI.message("üîç Running SwiftLint...")

    # Ensure SwiftLint is installed
    begin
      swiftlint_path = sh("command -v swiftlint", log: false).strip
      UI.message("‚úÖ SwiftLint found at: #{swiftlint_path}")
    rescue => exception
      UI.message("‚ö†Ô∏è  SwiftLint not found, installing via Homebrew...")
      sh("brew install swiftlint")
      UI.success("‚úÖ SwiftLint installed successfully")
    end

    # Create reports directory
    sh("mkdir -p reports")

    # Run SwiftLint
    swiftlint(
      mode: :lint,
      output_file: "#{FASTLANE_REPORTS_DIR}/swiftlint.xml",
      raise_if_swiftlint_error: false,
      reporter: "junit",
      ignore_exit_status: true
    )

    UI.success("‚úÖ SwiftLint passed")
  end

  # ========================
  # Testing
  # ========================

  desc "Run unit tests"
  lane :unit_test do
    UI.message("üß™ Running unit tests...")
    run_tests(
      project: "attentive-ios-sdk.xcodeproj",
      scheme: "attentive-ios-sdk-framework",
      device: "#{FASTLANE_TEST_DEVICE}",
      output_directory: "#{FASTLANE_TEST_OUTPUT_DIR}",
      output_types: "html,junit",
      result_bundle: true
    )

    UI.success("‚úÖ Unit tests passed")
  end

  desc "Run UI tests"
  lane :ui_test do
    UI.message("üé® Running UI tests...")
    scan(
      workspace: "attentive-ios-sdk.xcworkspace",
      scheme: "CreativeUITest",
      device: "#{FASTLANE_TEST_DEVICE}",
      output_directory: "#{FASTLANE_TEST_OUTPUT_DIR}",
      output_types: "html,junit",
      result_bundle: true
    )

    UI.success("‚úÖ UI tests passed")
  end

  # ========================
  # Error Handling
  # ========================

  error do |lane, exception|
    UI.error("‚ùå Lane #{lane} failed with error:")
    UI.error(exception.message)

    # Add custom error handling here (Slack notifications, etc.)
  end
end