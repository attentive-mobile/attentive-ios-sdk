# Fastfile for Attentive iOS SDK
# This file contains the fastlane lanes for building, testing, and deploying the iOS SDK

FASTLANE_REPORTS_DIR=ENV['FASTLANE_REPORTS_DIR'] || "fastlane/reports"
FASTLANE_TEST_OUTPUT_DIR=ENV['FASTLANE_TEST_OUTPUT_DIR'] || "fastlane/test_output"
FASTLANE_TEST_DEVICE=ENV['FASTLANE_TEST_DEVICE'] || "iPhone 16 Pro"

default_platform(:ios)

platform :ios do
  # ========================
  # Setup and Dependencies
  # ========================
  before_all do
    setup_ci if ENV['CI']
  end

  desc "Setup dependencies and environment"
  lane :setup do
    UI.message("üîß Setting up dependencies...")

    # Resolve Swift Package Manager dependencies
    xcodebuild(
      workspace: "attentive-ios-sdk.xcworkspace",
      scheme: "attentive-ios-sdk-framework",
      xcargs: "-resolvePackageDependencies"
    )

    UI.success("‚úÖ Dependencies resolved successfully")
  end

  # ========================
  # Code Quality
  # ========================

  desc "Run SwiftLint"
  lane :lint do
    UI.message("üîç Running SwiftLint...")

    # Ensure SwiftLint is installed
    begin
      swiftlint_path = sh("command -v swiftlint", log: false).strip
      UI.message("‚úÖ SwiftLint found at: #{swiftlint_path}")
    rescue => exception
      UI.message("‚ö†Ô∏è  SwiftLint not found, installing via Homebrew...")
      sh("brew install swiftlint")
      UI.success("‚úÖ SwiftLint installed successfully")
    end

    # Create reports directory
    sh("mkdir -p reports")

    # Run SwiftLint
    swiftlint(
      mode: :lint,
      output_file: "#{FASTLANE_REPORTS_DIR}/swiftlint.xml",
      raise_if_swiftlint_error: false,
      reporter: "junit",
      ignore_exit_status: true
    )

    UI.success("‚úÖ SwiftLint passed")
  end

  # ========================
  # Testing
  # ========================

  desc "Run unit tests"
  lane :unit_test do
    UI.message("üß™ Running unit tests...")
    run_tests(
      project: "attentive-ios-sdk.xcodeproj",
      scheme: "attentive-ios-sdk-framework",
      device: "#{FASTLANE_TEST_DEVICE}",
      output_directory: "#{FASTLANE_TEST_OUTPUT_DIR}",
      output_types: "html,junit",
      result_bundle: true
    )

    UI.success("‚úÖ Unit tests passed")
  end

  # ========================
  # Build
  # ========================
  lane :build_xcframework do
    project       = "attentive-ios-sdk.xcodeproj"
    scheme        = "attentive-ios-sdk-framework"
    configuration = "Release"
    framework     = "ATTNSDKFramework"
    output_root   = File.expand_path("Build/XCFramework")

    UI.message "=== Building #{framework} XCFrameworks (scheme: #{scheme}, config: #{configuration}) ==="

    # Build for device
    UI.message "=== [1/3] Build iOS device framework ==="
    build_ios_app(
      project: "#{project}",
      scheme: "#{scheme}",
      configuration: "#{configuration}",
      skip_package_ipa: true,
      skip_archive: true,
      destination: "generic/platform=iOS",
      derived_data_path: "#{output_root}/DerivedData-ios",
      xcargs: "SKIP_INSTALL=NO, BUILD_LIBRARY_FOR_DISTRIBUTION=YES"
    )

    ios_framework = "#{output_root}/DerivedData-ios/Build/Products/#{configuration}-iphoneos/#{framework}.framework"
    UI.user_error!("iOS device framework not found at #{ios_framework}") unless File.directory?(ios_framework)

    # Build for simulator
    UI.message "=== [2/3] Build iOS simulator framework ==="
    build_ios_app(
      project: "#{project}",
      scheme: "#{scheme}",
      configuration: "#{configuration}",
      skip_package_ipa: true,
      skip_archive: true,
      destination: "generic/platform=iOS Simulator",
      derived_data_path: "#{output_root}/DerivedData-sim",
      xcargs: "SKIP_INSTALL=NO, BUILD_LIBRARY_FOR_DISTRIBUTION=YES"
    )

    sim_framework = "#{output_root}/DerivedData-sim/Build/Products/#{configuration}-iphonesimulator/#{framework}.framework"
    UI.user_error!("Simulator framework not found at #{sim_framework}") unless File.directory?(sim_framework)

    # Create universal framework
    UI.message "=== [3/3] Create universal XCFramework (device + sim) ==="
    universal_xcframework = "#{output_root}/#{framework}.xcframework"
    create_xcframework(
      frameworks: [
        "#{ios_framework}",
        "#{sim_framework}"
      ],
      output: "#{universal_xcframework}"
    )
    UI.success "Universal XCFramework -> #{universal_xcframework}"

    sh("find #{output_root}/#{framework}.xcframework -name '*.swiftsourceinfo' -delete")
    sh("find #{output_root}/#{framework}.xcframework -type d -name 'Project' -empty -delete")
    
    UI.success "‚úÖ Done building attentive-ios-sdk XCFrameworks"
  end

  # ========================
  # Error Handling
  # ========================

  error do |lane, exception|
    UI.error("‚ùå Lane #{lane} failed with error:")
    UI.error(exception.message)

    # Add custom error handling here (Slack notifications, etc.)
  end
end