# Fastfile for Attentive iOS SDK
# This file contains the fastlane lanes for building, testing, and deploying the iOS SDK

default_platform(:ios)

platform :ios do
  # ========================
  # Setup and Dependencies
  # ========================
  before_all do
    setup_circle_ci
  end

  desc "Setup dependencies and environment"
  lane :setup do
    UI.message("üîß Setting up dependencies...")

    # Resolve Swift Package Manager dependencies
    xcodebuild(
      workspace: "attentive-ios-sdk.xcworkspace",
      scheme: "attentive-ios-sdk-framework",
      xcargs: "-resolvePackageDependencies"
    )

    UI.success("‚úÖ Dependencies resolved successfully")
  end

  # ========================
  # Code Quality
  # ========================

  desc "Run SwiftLint"
  lane :lint do
    UI.message("üîç Running SwiftLint...")

    # Ensure SwiftLint is installed
    begin
      swiftlint_path = sh("command -v swiftlint", log: false).strip
      UI.message("‚úÖ SwiftLint found at: #{swiftlint_path}")
    rescue => exception
      UI.message("‚ö†Ô∏è  SwiftLint not found, installing via Homebrew...")
      sh("brew install swiftlint")
      UI.success("‚úÖ SwiftLint installed successfully")
    end

    # Create reports directory
    sh("mkdir -p reports")

    # Run SwiftLint with default reporter (will fail if issues found)
    swiftlint(
      mode: :lint,
      output_file: "#{ENV["FASTLANE_REPORTS_DIR"]}/swiftlint.html",
      raise_if_swiftlint_error: false,
      reporter: "html",
      ignore_exit_status: true
    )

    UI.success("‚úÖ SwiftLint passed")
  end

  # ========================
  # Error Handling
  # ========================

  error do |lane, exception|
    UI.error("‚ùå Lane #{lane} failed with error:")
    UI.error(exception.message)

    # Add custom error handling here (Slack notifications, etc.)
  end
end